<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PCPartsHub Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

<style>
/* ================= THEME ================= */
:root{
  --bg:#0b0e14;
  --panel:#121723;
  --panel2:#161c2e;
  --accent:#4f7cff;
  --text:#e6e8ee;
  --muted:#9aa1b2;
  --danger:#ff5c5c;
  --success:#28c76f;
  --radius:14px;

  --border:#1c2340;
  --border2:#222b52;
  --box:#13203f;
  --boxBorder:#23336d;
  --hover:#1a2550;
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:Inter,sans-serif;
  background:radial-gradient(1200px 600px at 20% -10%,#16204a,transparent),var(--bg);
  color:var(--text);
  min-height:100vh;
}

/* ================= TOP ================= */
.top-bar{
  background:var(--panel2);
  padding:12px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--border);
}

.logo{
  font-size:20px;
  font-weight:700;
  letter-spacing:.2px;
}

.profile{
  display:flex;
  gap:12px;
  align-items:center;
  color:var(--muted);
  font-weight:500;
}

.profile img{
  width:36px;
  height:36px;
  border-radius:50%;
  border:2px solid var(--accent);
}

/* ================= NAV ================= */
.nav-bar{
  display:flex;
  gap:18px;
  padding:14px 40px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
}

.nav-item{
  color:var(--muted);
  text-decoration:none;
  padding:10px 16px;
  border-radius:12px;
  transition:.2s;
}

.nav-item:hover{
  background:var(--hover);
  color:#fff;
  box-shadow:0 0 0 1px rgba(79,124,255,.35);
}

.nav-item.active{
  background:linear-gradient(135deg,#4f7cff,#6fa3ff);
  color:#fff;
}

/* ================= HEADER ================= */
.header{
  padding:22px 40px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--border);
}

.header h2{
  font-size:30px;
  font-weight:800;
}

.budget{
  background:rgba(18,23,35,.75);
  border:1px solid var(--border);
  padding:12px 16px;
  border-radius:16px;
  display:flex;
  gap:14px;
  align-items:center;
  color:var(--muted);
  backdrop-filter: blur(6px);

  font-size:16px;       /* bigger label */
  font-weight:700;
}

.budget .budget-label{
  font-size:16px;       /* bigger */
  font-weight:800;
  letter-spacing:.2px;
  margin-left:-2px;     /* slightly left */
}

.budget input{
  background:none;
  border:none;
  color:var(--text);
  width:110px;
  text-align:right;
  outline:none;
  font-weight:800;
  font-size:16px;       /* keep number matching */
}


/* ================= LAYOUT ================= */
main{
  padding:46px 40px 30px;
  display:grid;
  grid-template-columns:2.6fr 1fr;
  gap:30px;
}

/* Panels */
.parts,.summary{
  background:rgba(18,23,35,.78);
  border:1px solid var(--border);
  border-radius:18px;
  padding:28px;
  backdrop-filter: blur(8px);
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
}

.parts h3,
.summary h3{
  font-size:22px;
  font-weight:800;
  margin-bottom:18px;
}

/* ================= CONFIG ROWS ================= */
.row{
  display:grid;
  grid-template-columns:160px 1fr 46px 120px;
  gap:14px;
  padding:14px 0;
  border-bottom:1px solid rgba(28,35,64,.9);
  align-items:center;
}

.label{
  color:var(--muted);
  font-weight:600;
  font-size:18px;
}

.choose{
  background:rgba(22,28,46,.92);
  border:1px solid var(--border2);
  color:#fff;
  padding:12px 14px;
  border-radius:14px;
  cursor:pointer;
  transition:.2s;
  text-align:center;
  font-weight:700;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.choose:hover{
  background:#1f2a55;
  box-shadow:0 0 0 1px rgba(79,124,255,.55);
}

.price{
  text-align:right;
  color:var(--muted);
  font-weight:700;
}

/* Remove button: show only when selected AND row hovered */
.remove-btn{
  width:46px;
  height:46px;
  padding:0;
  border-radius:14px;
  background:#1a2036;
  border:1px solid var(--border2);
  color:var(--muted);
  cursor:pointer;
  opacity:0;
  pointer-events:none;
  transition:.2s;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
}

.remove-btn.show{
  opacity:0; /* still hidden until hover */
}

.row:hover .remove-btn.show{
  opacity:1;
  pointer-events:auto;
}

.remove-btn:hover{
  color:#fff;
  background:#2a1630;
  box-shadow:0 0 0 1px rgba(255,92,92,.6);
}

/* Clear */
.clear{
  width:100%;
  margin-top:18px;
  padding:16px;
  border:none;
  border-radius:16px;
  font-weight:800;
  cursor:pointer;
  background:var(--danger);
  color:#fff;
  transition:.2s;
}

.clear:hover{
  filter:brightness(1.1);
  box-shadow:0 0 0 2px rgba(255,92,92,.25);
}

/* ================= SUMMARY ================= */
.total{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:22px;
  font-weight:800;
  margin-bottom:14px;
}

.box{
  background:var(--box);
  border:1px solid var(--boxBorder);
  padding:14px;
  border-radius:14px;
  font-size:14px;
  margin-bottom:12px;
  white-space:pre-line;
}

.summary-actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-top:16px;
}

.btn{
  width:100%;
  padding:16px;
  border:none;
  border-radius:16px;
  font-weight:800;
  cursor:pointer;
  color:#fff;
  transition:.2s;
}

.btn:hover{
  filter:brightness(1.12);
  box-shadow:0 0 0 2px rgba(255,255,255,.12);
}

.check{
  background:linear-gradient(135deg,#28c76f,#3fe08f);
}

.save{
  background:linear-gradient(135deg,#4f7cff,#6fa3ff);
}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(6,9,20,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}

.modal-box{
  background:rgba(18,23,35,.96);
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;
  width:1040px;
  max-width:96%;
  max-height:86vh;
  display:flex;
  flex-direction:column;
  backdrop-filter: blur(10px);
  box-shadow:0 30px 90px rgba(0,0,0,.6);
}

.modal-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:14px;
  padding-bottom:14px;
  border-bottom:1px solid rgba(28,35,64,.9);
}

.modal-title{
  font-weight:900;
  letter-spacing:.3px;
}

.modal-x{
  cursor:pointer;
  color:var(--muted);
  padding:10px 14px;
  border-radius:14px;
  border:1px solid var(--border2);
  background:transparent;
  transition:.2s;
  font-weight:800;
}

.modal-x:hover{
  color:#fff;
  background:var(--hover);
  box-shadow:0 0 0 1px rgba(79,124,255,.35);
}

.modal-controls{
  display:grid;
  grid-template-columns:1.35fr .85fr .85fr .95fr;
  gap:12px;
  margin-top:14px;
}

.modal-controls input,
.modal-controls select{
  background:rgba(22,28,46,.92);
  border:1px solid var(--border2);
  color:var(--text);
  padding:12px 12px;
  border-radius:14px;
  outline:none;
  font-weight:600;
}

.modal-controls input::placeholder{color:#6f7890}

.modal-meta{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  color:var(--muted);
  font-size:12px;
}

.modal-grid{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:14px;
  overflow:auto;
  padding-right:6px;
}

/* Card */
.card{
  background:rgba(22,28,46,.92);
  border:1px solid var(--border2);
  border-radius:16px;
  padding:14px;
  cursor:pointer;
  transition:.2s;
  display:flex;
  flex-direction:column;
  gap:10px;
  min-height:132px;
  opacity:0;             /* for animation */
  transform: translateY(10px) scale(.98);
}

.card:hover{
  background:#1f2a55;
  box-shadow:0 0 0 1px rgba(79,124,255,.55);
}

.card .name{
  font-weight:900;
  font-size:14px;
  line-height:1.25;
}

.card .sub{
  color:var(--muted);
  font-size:12px;
  line-height:1.2;
}

.card .bottom{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  margin-top:auto;
}

.badge{
  font-size:11px;
  padding:5px 9px;
  border-radius:999px;
  border:1px solid #2a3566;
  color:#cdd5ff;
  background:#111a33;
  font-weight:700;
}

.price2{
  font-weight:900;
  color:#a9c3ff;
}

/* Staggered animation */
@keyframes cardIn{
  to{
    opacity:1;
    transform: translateY(0) scale(1);
  }
}

/* ================= FOOTER ================= */
.footer{
  margin-top:34px;
  border-top:1px solid var(--border);
  background:rgba(10,14,30,.8);
}

.footer-inner{
  max-width:1200px;
  margin:auto;
  padding:22px 40px;
  display:flex;
  justify-content:space-between;
  color:var(--muted);
  font-size:14px;
}

/* Scrollbar subtle */
.modal-grid::-webkit-scrollbar{width:10px}
.modal-grid::-webkit-scrollbar-thumb{background:#1a2550;border-radius:10px}
.modal-grid::-webkit-scrollbar-track{background:transparent}
</style>
</head>

<body>

<!-- TOP -->
<div class="top-bar">
  <div class="logo">PCPartsHub</div>
  <div class="profile">
    <img src="https://i.pravatar.cc/36" alt="profile" />
    Ahmed
  </div>
</div>

<!-- NAV -->
<nav class="nav-bar">
  <a class="nav-item active">Builder</a>
  <a href="pcready.html" class="nav-item">Completed</a>
  <a href="graph.html" class="nav-item">Graphs</a>
</nav>

<!-- HEADER -->
<div class="header">
  <h2>Advanced PC Builder</h2>
  <div class="budget">
  <span class="budget-label">Budget DH</span>
  <input id="budgetInput" type="number" value="15000" />
</div>

</div>

<!-- MAIN -->
<main>
  <!-- PARTS -->
  <section class="parts">
    <h3>Configuration</h3>

    <div class="row" data-part="cpu">
      <div class="label">CPU</div>
      <div class="choose" onclick="openModal(this)">Choose</div>
      <button class="remove-btn" title="Remove" onclick="removeSelected(event,'cpu')">✕</button>
      <div id="cpuP" class="price">—</div>
    </div>

    <div class="row" data-part="mb">
      <div class="label">Motherboard</div>
      <div class="choose" onclick="openModal(this)">Choose</div>
      <button class="remove-btn" title="Remove" onclick="removeSelected(event,'mb')">✕</button>
      <div id="mbP" class="price">—</div>
    </div>

    <div class="row" data-part="gpu">
      <div class="label">GPU</div>
      <div class="choose" onclick="openModal(this)">Choose</div>
      <button class="remove-btn" title="Remove" onclick="removeSelected(event,'gpu')">✕</button>
      <div id="gpuP" class="price">—</div>
    </div>

    <div class="row" data-part="ram">
      <div class="label">RAM</div>
      <div class="choose" onclick="openModal(this)">Choose</div>
      <button class="remove-btn" title="Remove" onclick="removeSelected(event,'ram')">✕</button>
      <div id="ramP" class="price">—</div>
    </div>

    <div class="row" data-part="storage">
      <div class="label">Storage</div>
      <div class="choose" onclick="openModal(this)">Choose</div>
      <button class="remove-btn" title="Remove" onclick="removeSelected(event,'storage')">✕</button>
      <div id="storageP" class="price">—</div>
    </div>

    <div class="row" data-part="psu">
      <div class="label">PSU</div>
      <div class="choose" onclick="openModal(this)">Choose</div>
      <button class="remove-btn" title="Remove" onclick="removeSelected(event,'psu')">✕</button>
      <div id="psuP" class="price">—</div>
    </div>

    <div class="row" data-part="case">
      <div class="label">Case</div>
      <div class="choose" onclick="openModal(this)">Choose</div>
      <button class="remove-btn" title="Remove" onclick="removeSelected(event,'case')">✕</button>
      <div id="caseP" class="price">—</div>
    </div>

    <button class="clear" id="clearBtn">Clear configuration</button>
  </section>

  <!-- SUMMARY -->
  <aside class="summary">
    <h3>Summary</h3>

    <div class="total">
      <span>Total</span>
      <span id="totalEl">0 DH</span>
    </div>

    <div class="box" id="compatBox">Compatibility: —</div>
    <div class="box" id="powerBox">Power: —</div>

    <div class="summary-actions">
      <button class="btn check" id="checkBtn">Check</button>
      <button class="btn save" id="saveBtn">Save</button>
    </div>
  </aside>
</main>

<!-- MODAL -->
<div class="modal" id="modal">
  <div class="modal-box">
    <div class="modal-top">
      <div class="modal-title" id="modalTitle">Select</div>
      <button class="modal-x" id="modalCloseBtn" type="button">✕</button>
    </div>

    <div class="modal-controls">
      <input id="searchInput" type="text" placeholder="Search (e.g. RTX, Ryzen, DDR5, MSI)" />
      <select id="brandFilter"></select>
      <input id="maxPriceInput" type="number" placeholder="Max price (DH)" />
      <select id="sortSelect">
        <option value="rec">Recommended</option>
        <option value="plh">Price: Low → High</option>
        <option value="phl">Price: High → Low</option>
      </select>
    </div>

    <div class="modal-meta">
      <span id="resultsMeta">0 results</span>
      <span>Click a card to select</span>
    </div>

    <div class="modal-grid" id="modalGrid"></div>
  </div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-inner">
    <span>© 2026 PCPartsHub</span>
    <span>Morocco PC Parts Price Comparator</span>
  </div>
</footer>

<script>
/* ================= DATA (real product names) ================= */
const data = {
  cpu:[
    {id:"i3_12100", n:"Intel i3-12100", p:1200, socket:"LGA1700", w:60},
    {id:"i5_12400", n:"Intel i5-12400", p:1800, socket:"LGA1700", w:65},
    {id:"i7_12700", n:"Intel i7-12700K", p:3200, socket:"LGA1700", w:125},
    {id:"i9_12900", n:"Intel i9-12900K", p:5200, socket:"LGA1700", w:125},
    {id:"r3_4100",  n:"Ryzen 3 4100", p:1000, socket:"AM4", w:65},
    {id:"r5_5600",  n:"Ryzen 5 5600", p:1700, socket:"AM4", w:65},
    {id:"r7_5800x", n:"Ryzen 7 5800X", p:2800, socket:"AM4", w:105},
    {id:"r7_7700",  n:"Ryzen 7 7700X", p:3800, socket:"AM5", w:105},
    {id:"r9_7950x", n:"Ryzen 9 7950X", p:7200, socket:"AM5", w:170}
  ],
  mb:[
    {id:"b460", n:"MSI B460 (LGA1200 DDR4)", p:1100, socket:"LGA1200", ram:"DDR4", w:20},
    {id:"b660", n:"MSI B660 (LGA1700 DDR4)", p:1400, socket:"LGA1700", ram:"DDR4", w:25},
    {id:"z690", n:"ASUS Z690 (LGA1700 DDR5)", p:2200, socket:"LGA1700", ram:"DDR5", w:30},
    {id:"x570", n:"Gigabyte X570 (AM4 DDR4)", p:1800, socket:"AM4", ram:"DDR4", w:30},
    {id:"b550", n:"Gigabyte B550 (AM4 DDR4)", p:1300, socket:"AM4", ram:"DDR4", w:22},
    {id:"x670", n:"ASRock X670 (AM5 DDR5)", p:2600, socket:"AM5", ram:"DDR5", w:35},
    {id:"x470", n:"ASUS X470 (AM4 DDR4)", p:1400, socket:"AM4", ram:"DDR4", w:25},
    {id:"z790", n:"MSI Z790 (LGA1700 DDR5)", p:3000, socket:"LGA1700", ram:"DDR5", w:35}
  ],
  gpu:[
    {id:"gtx1650", n:"GTX 1650", p:2000, w:75},
    {id:"rtx3050", n:"RTX 3050", p:3200, w:130},
    {id:"rtx3060", n:"RTX 3060", p:3500, w:170},
    {id:"rtx3070", n:"RTX 3070", p:4800, w:220},
    {id:"rtx4070", n:"RTX 4070", p:6500, w:200},
    {id:"rx6600",  n:"RX 6600 XT", p:3000, w:160},
    {id:"rx6700",  n:"RX 6700 XT", p:4200, w:230},
    {id:"rx7800",  n:"RX 7800 XT", p:7000, w:260},
    {id:"rx7900",  n:"RX 7900 XT", p:8500, w:300}
  ],
  ram:[
    {id:"8ddr4",  n:"8GB DDR4",  p:400,  type:"DDR4", w:3},
    {id:"16ddr4", n:"16GB DDR4", p:700,  type:"DDR4", w:5},
    {id:"32ddr4", n:"32GB DDR4", p:1200, type:"DDR4", w:7},
    {id:"16ddr5", n:"16GB DDR5", p:1200, type:"DDR5", w:6},
    {id:"32ddr5", n:"32GB DDR5", p:2000, type:"DDR5", w:8},
    {id:"64ddr5", n:"64GB DDR5", p:3800, type:"DDR5", w:10}
  ],
  storage:[
    {id:"ssd500",  n:"NVMe SSD 500GB", p:600,  w:4},
    {id:"ssd1",    n:"NVMe SSD 1TB",   p:900,  w:5},
    {id:"ssd2",    n:"NVMe SSD 2TB",   p:1600, w:6},
    {id:"hdd1",    n:"HDD 1TB",        p:400,  w:7},
    {id:"hdd2",    n:"HDD 2TB",        p:700,  w:7},
    {id:"sshddcombo", n:"1TB SSD + 2TB HDD", p:1400, w:12}
  ],
  psu:[
    {id:"550", p:"550W Bronze", p:550, psuW:550},
    {id:"650", n:"650W Bronze", p:700,  psuW:650},
    {id:"750", n:"750W Gold",   p:1000, psuW:750},
    {id:"850", n:"850W Gold",   p:1400, psuW:850},
    {id:"1000", n:"1000W Platinum", p:2000, psuW:1000}
  ],
  case:[
    {id:"nzxt",    n:"NZXT H510",       p:700,  w:0},
    {id:"corsair", n:"Corsair 4000D",   p:800,  w:0},
    {id:"lianli",  n:"Lian Li O11",     p:1400, w:0},
    {id:"coolermaster", n:"Cooler Master NR600", p:600, w:0},
    {id:"phanteks", n:"Phanteks Eclipse P400A", p:900, w:0},
    {id:"fractal",  n:"Fractal Design Meshify C", p:850, w:0}
  ]
};



/* ================= HELPERS ================= */
function getBrand(name){
  const s = (name || "").toLowerCase();
  if(s.includes("intel")) return "Intel";
  if(s.includes("ryzen")) return "AMD";
  if(s.includes("msi")) return "MSI";
  if(s.includes("asus")) return "ASUS";
  if(s.includes("gigabyte")) return "Gigabyte";
  if(s.includes("asrock")) return "ASRock";
  if(s.includes("rtx")) return "NVIDIA";
  if(s.includes("rx")) return "AMD Radeon";
  if(s.includes("nzxt")) return "NZXT";
  if(s.includes("corsair")) return "Corsair";
  if(s.includes("lian li")) return "Lian Li";
  if(s.includes("ddr4")) return "DDR4";
  if(s.includes("ddr5")) return "DDR5";
  return "Other";
}

function badgeFor(partKey, item){
  if(partKey === "cpu") return item.socket || getBrand(item.n);
  if(partKey === "mb") return `${item.socket || ""} ${item.ram || ""}`.trim();
  if(partKey === "ram") return item.type || getBrand(item.n);
  if(partKey === "psu") return `${item.psuW || 0}W`;
  return getBrand(item.n);
}

function wattsFor(partKey, item){
  if(partKey === "psu") return `${item.psuW || 0}W`;
  return item.w ? `${item.w}W` : "—";
}

/* ================= STATE ================= */
const STORAGE_KEY = "pcpartshub_state_full_v1";

const state = {
  selected: { cpu:null, mb:null, gpu:null, ram:null, storage:null, psu:null, case:null }
};

let activeRow = null;
let activePartKey = null;

/* ================= DOM ================= */
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modalTitle");
const modalGrid = document.getElementById("modalGrid");
const searchInput = document.getElementById("searchInput");
const brandFilter = document.getElementById("brandFilter");
const maxPriceInput = document.getElementById("maxPriceInput");
const sortSelect = document.getElementById("sortSelect");
const resultsMeta = document.getElementById("resultsMeta");

const totalEl = document.getElementById("totalEl");
const compatBox = document.getElementById("compatBox");
const powerBox = document.getElementById("powerBox");
const budgetInput = document.getElementById("budgetInput");

/* ================= MODAL OPEN/CLOSE ================= */
function openModal(btn){
  activeRow = btn.closest(".row");
  activePartKey = activeRow.dataset.part;

  modalTitle.textContent = `Select ${activePartKey.toUpperCase()}`;

  // reset controls (keep sane defaults)
  searchInput.value = "";
  maxPriceInput.value = "";
  sortSelect.value = "rec";

  populateBrandFilter();
  renderModalList(true);

  modal.style.display = "flex";
  // focus search for speed
  setTimeout(()=>searchInput.focus(), 0);
}

function closeModal(){
  modal.style.display = "none";
  activeRow = null;
  activePartKey = null;
}

document.getElementById("modalCloseBtn").addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

/* ================= FILTERS ================= */
function populateBrandFilter(){
  const items = data[activePartKey] || [];
  const brands = Array.from(new Set(items.map(i => getBrand(i.n)))).sort();
  brandFilter.innerHTML =
    `<option value="__all">All brands</option>` +
    brands.map(b => `<option value="${b}">${b}</option>`).join("");
  brandFilter.value = "__all";
}

function applyFilters(items){
  const q = searchInput.value.trim().toLowerCase();
  const b = brandFilter.value;
  const maxP = Number(maxPriceInput.value || 0);
  const sort = sortSelect.value;

  let out = items.slice();

  if(q) out = out.filter(i => (i.n || "").toLowerCase().includes(q));
  if(b !== "__all") out = out.filter(i => getBrand(i.n) === b);
  if(maxP > 0) out = out.filter(i => Number(i.p || 0) <= maxP);

  if(sort === "plh") out.sort((a,c)=>(a.p||0)-(c.p||0));
  if(sort === "phl") out.sort((a,c)=>(c.p||0)-(a.p||0));
  return out;
}

/* ================= STAGGER ANIMATION ================= */
function animateCardsStagger(){
  const cards = Array.from(modalGrid.querySelectorAll(".card"));
  // trigger reflow to restart animations cleanly
  // eslint-disable-next-line no-unused-expressions
  modalGrid.offsetHeight;

  cards.forEach((card, idx)=>{
    const delay = 30 * idx; // ms stagger
    card.style.animation = `cardIn 260ms ease-out forwards`;
    card.style.animationDelay = `${delay}ms`;
  });
}

/* ================= RENDER MODAL LIST ================= */
function renderModalList(animate){
  const items = data[activePartKey] || [];
  const filtered = applyFilters(items);

  resultsMeta.textContent = `${filtered.length} result${filtered.length === 1 ? "" : "s"}`;

  modalGrid.innerHTML = "";

  filtered.forEach((item)=>{
    const brand = getBrand(item.n);
    const badge = badgeFor(activePartKey, item);
    const watts = wattsFor(activePartKey, item);

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="name">${item.n}</div>
      <div class="sub">${activePartKey.toUpperCase()} • ${brand}</div>
      <div class="bottom">
        <span class="badge">${badge || "—"}</span>
        <div style="text-align:right">
          <div class="price2">${item.p} DH</div>
          <div class="sub" style="margin-top:2px">${watts}</div>
        </div>
      </div>
    `;
    card.addEventListener("click", ()=>selectItem(item));
    modalGrid.appendChild(card);
  });

  // stagger animation after DOM is filled
  if(animate) requestAnimationFrame(animateCardsStagger);
}

/* Live filter events */
searchInput.addEventListener("input", ()=>renderModalList(true));
brandFilter.addEventListener("change", ()=>renderModalList(true));
maxPriceInput.addEventListener("input", ()=>renderModalList(true));
sortSelect.addEventListener("change", ()=>renderModalList(true));

/* ================= SELECT ITEM ================= */
function selectItem(item){
  if(!activePartKey || !activeRow) return;

  state.selected[activePartKey] = item;

  // update row UI
  activeRow.querySelector(".choose").textContent = item.n;
  const priceEl = document.getElementById(activePartKey + "P");
  if(priceEl) priceEl.textContent = `${item.p} DH`;

  const rm = activeRow.querySelector(".remove-btn");
  if(rm) rm.classList.add("show");

  recalc();
  closeModal();
}

/* ================= REMOVE PER PART ================= */
function removeSelected(ev, partKey){
  ev.stopPropagation();
  state.selected[partKey] = null;

  const row = document.querySelector(`.row[data-part="${CSS.escape(partKey)}"]`);
  if(row){
    row.querySelector(".choose").textContent = "Choose";
    const rm = row.querySelector(".remove-btn");
    if(rm) rm.classList.remove("show");
  }

  const priceEl = document.getElementById(partKey + "P");
  if(priceEl) priceEl.textContent = "—";

  recalc();
  compatBox.textContent = "Compatibility: —";
}

/* ================= TOTAL + POWER ================= */
function recalc(){
  let total = 0;
  let drawW = 0;

  Object.entries(state.selected).forEach(([k,v])=>{
    if(!v) return;
    total += Number(v.p || 0);

    // PSU is capacity, not draw
    if(k === "psu") return;
    drawW += Number(v.w || 0);
  });

  totalEl.textContent = `${total} DH`;
  powerBox.textContent = `Power: ${drawW ? drawW + " W" : "—"}`;
}

/* ================= CHECK COMPATIBILITY ================= */
function checkCompatibility(){
  const cpu = state.selected.cpu;
  const mb  = state.selected.mb;
  const ram = state.selected.ram;
  const psu = state.selected.psu;

  let drawW = 0;
  Object.entries(state.selected).forEach(([k,v])=>{
    if(!v) return;
    if(k === "psu") return;
    drawW += Number(v.w || 0);
  });

  let total = 0;
  Object.values(state.selected).forEach(v=>{ if(v) total += Number(v.p||0); });

  const budget = Number(budgetInput.value || 0);
  const issues = [];

  if(cpu && mb && cpu.socket && mb.socket && cpu.socket !== mb.socket){
    issues.push("CPU and Motherboard socket mismatch");
  }

  if(mb && ram && mb.ram && ram.type && mb.ram !== ram.type){
    issues.push("RAM type incompatible");
  }

  if(psu && psu.psuW && drawW > psu.psuW * 0.85){
    issues.push("PSU insufficient (no headroom)");
  }

  if(budget && total > budget){
    issues.push("Over budget");
  }

  compatBox.textContent =
    issues.length ? `Issues:\n- ${issues.join("\n- ")}` : "Compatibility: Compatible ✓";
}

/* ================= SAVE / LOAD / CLEAR ================= */
function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  alert("Saved");
}

function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;

  try{
    const saved = JSON.parse(raw);
    if(!saved || !saved.selected) return;

    state.selected = saved.selected;

    Object.keys(state.selected).forEach((k)=>{
      const v = state.selected[k];
      const row = document.querySelector(`.row[data-part="${CSS.escape(k)}"]`);
      const priceEl = document.getElementById(k + "P");

      if(!row) return;

      if(v){
        row.querySelector(".choose").textContent = v.n;
        if(priceEl) priceEl.textContent = `${v.p} DH`;
        const rm = row.querySelector(".remove-btn");
        if(rm) rm.classList.add("show");
      }else{
        row.querySelector(".choose").textContent = "Choose";
        if(priceEl) priceEl.textContent = "—";
        const rm = row.querySelector(".remove-btn");
        if(rm) rm.classList.remove("show");
      }
    });

    recalc();
  }catch(e){
    // ignore corrupted storage
  }
}

function clearAll(){
  Object.keys(state.selected).forEach(k => state.selected[k] = null);

  document.querySelectorAll(".row").forEach(r=>{
    r.querySelector(".choose").textContent = "Choose";
    const rm = r.querySelector(".remove-btn");
    if(rm) rm.classList.remove("show");
  });

  ["cpu","mb","gpu","ram","storage","psu","case"].forEach(k=>{
    const priceEl = document.getElementById(k + "P");
    if(priceEl) priceEl.textContent = "—";
  });

  totalEl.textContent = "0 DH";
  compatBox.textContent = "Compatibility: —";
  powerBox.textContent = "Power: —";
}

/* ================= EVENTS ================= */
document.getElementById("checkBtn").addEventListener("click", checkCompatibility);
document.getElementById("saveBtn").addEventListener("click", saveState);
document.getElementById("clearBtn").addEventListener("click", clearAll);

// ESC closes modal
document.addEventListener("keydown", (e)=>{
  if(e.key === "Escape" && modal.style.display === "flex") closeModal();
});

/* ================= INIT ================= */
loadState();
recalc();
</script>

</body>
</html>
